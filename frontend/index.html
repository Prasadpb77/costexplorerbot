<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AWS Cost Chat</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #121931;
      --muted: #8b95b7;
      --text: #e7eaff;
      --primary: #6ea8fe;
      --accent: #21d4fd;
      --danger: #ff6b6b;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 800px at 80% -10%, #1e2650 0%, transparent 50%), var(--bg);
      color: var(--text);
    }

    .app {
      height: 100vh; display: grid; grid-template-rows: auto 1fr auto; max-width: 920px; margin: 0 auto;
      padding: 16px; gap: 12px;
    }

    header {
      display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; backdrop-filter: blur(6px);
    }
    .dot { width: 10px; height: 10px; border-radius: 999px; background: var(--accent); box-shadow: 0 0 14px var(--accent); }
    .title { font-weight: 700; letter-spacing: 0.2px; }
    .env { margin-left: auto; font-size: 12px; color: var(--muted); }

    #chat {
      background: var(--card); border: 1px solid rgba(255,255,255,0.06); border-radius: 18px; overflow: hidden; display: grid;
      grid-template-rows: 1fr auto; min-height: 0; box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }

    .messages {
      padding: 16px; overflow-y: auto; scroll-behavior: smooth; scrollbar-width: thin; gap: 10px; display: flex; flex-direction: column;
    }

    .bubble { max-width: 80%; padding: 12px 14px; border-radius: 14px; line-height: 1.4; font-size: 15px; white-space: pre-wrap; word-wrap: break-word; }
    .user   { align-self: flex-end; background: linear-gradient(180deg, #2a3568, #1f2a5a); border: 1px solid rgba(255,255,255,0.08); }
    .bot    { align-self: flex-start; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); }

    .row { display: flex; align-items: center; gap: 10px; }
    .avatar { width: 28px; height: 28px; border-radius: 999px; flex: 0 0 auto; display: grid; place-items: center; font-weight: 700; font-size: 12px; }
    .avatar.user { background: linear-gradient(180deg, #7aa2ff, #6a8dff); color: #091028; }
    .avatar.bot  { background: linear-gradient(180deg, #24e0a8, #14b8a6); color: #071b16; }

    .content { padding: 10px 12px; border-radius: 12px; }

    .composer { padding: 12px; border-top: 1px solid rgba(255,255,255,0.06); background: linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.2)); }
    .composer-inner { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
    textarea {
      resize: none; min-height: 48px; max-height: 160px; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.06); color: var(--text); outline: none; font-size: 15px; line-height: 1.35;
    }
    textarea::placeholder { color: var(--muted); }

    button {
      height: 48px; padding: 0 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); background: linear-gradient(180deg, #3b82f6, #2563eb); color: white;
      font-weight: 600; letter-spacing: .2px; cursor: pointer; box-shadow: 0 6px 16px rgba(59,130,246,.35);
    }
    button:disabled { opacity: .6; cursor: not-allowed; box-shadow: none; }

    .helper { display: flex; align-items: center; gap: 8px; color: var(--muted); font-size: 12px; padding: 0 2px 8px 2px; }
    .kbd { border: 1px solid rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 6px; font-weight: 600; font-size: 11px; color: #cfd6ff; }

    .status { font-size: 12px; color: var(--muted); padding-left: 6px; }
    .error { color: var(--danger); }

    .toolbar { display: flex; gap: 8px; align-items: center; }
    .small { font-size: 12px; color: var(--muted); }
    .toggle { appearance: none; width: 44px; height: 26px; background: #2a335d; border-radius: 999px; position: relative; border: 1px solid rgba(255,255,255,0.12); cursor: pointer; }
    .toggle:checked { background: #1f9cf1; }
    .toggle::after { content: ""; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 999px; transition: transform .18s ease; }
    .toggle:checked::after { transform: translateX(18px); }

    @media (max-width: 640px) {
      .bubble { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="dot"></div>
      <div class="title">AWS Cost Chat</div>
      <div class="env" id="envInfo"></div>
    </header>

    <section id="chat">
      <div id="messages" class="messages" aria-live="polite" aria-label="Chat transcript"></div>
      <div class="composer">
        <div class="helper">
          <span class="small">Press</span><span class="kbd">Enter</span><span class="small">to send,</span>
          <span class="kbd">Shift + Enter</span><span class="small">for newline.</span>
          <span class="status" id="status"></span>
        </div>
        <div class="composer-inner">
          <textarea id="input" placeholder="Ask: What are my AWS costs today?"></textarea>
          <div class="toolbar">
            <label class="small">Save chat
              <input type="checkbox" id="persist" class="toggle" aria-label="Toggle persistence" />
            </label>
            <button id="sendBtn" title="Send">Send</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ======== CONFIG ========
    // 1) Set your deployed API Gateway URL below (no trailing slash)
    //    Example: "https://abc123.execute-api.ap-south-1.amazonaws.com/prod"
    const API_URL = window.localStorage.getItem('API_URL') || ""; // optionally store via console for convenience

    // 2) Optionally, if your API requires a header (e.g., x-api-key), set it here.
    const EXTRA_HEADERS = JSON.parse(window.localStorage.getItem('EXTRA_HEADERS') || '{}');

    // ======== UTIL ========
    const qs  = (sel, el=document) => el.querySelector(sel);
    const qsa = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const messagesEl = qs('#messages');
    const inputEl    = qs('#input');
    const sendBtn    = qs('#sendBtn');
    const statusEl   = qs('#status');
    const persistEl  = qs('#persist');
    const envInfoEl  = qs('#envInfo');

    envInfoEl.textContent = API_URL ? new URL(API_URL).host : 'API URL not set';

    function setStatus(text, isError=false) {
      statusEl.textContent = text || '';
      statusEl.classList.toggle('error', !!isError);
    }

    function escapeHTML(str="") {
      return str.replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function addMessage(role, content) {
      const row = document.createElement('div');
      row.className = 'row';

      const avatar = document.createElement('div');
      avatar.className = `avatar ${role === 'user' ? 'user' : 'bot'}`;
      avatar.textContent = role === 'user' ? 'YOU' : 'AI';

      const bubble = document.createElement('div');
      bubble.className = `bubble ${role === 'user' ? 'user' : 'bot'}`;
      bubble.innerHTML = escapeHTML(content);

      row.appendChild(avatar);
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      if (persistEl.checked) saveHistory();
    }

    function saveHistory() {
      const items = qsa('.row').map(row => {
        const isUser = row.querySelector('.avatar').classList.contains('user');
        const text = row.querySelector('.bubble').textContent;
        return { role: isUser ? 'user' : 'assistant', content: text };
      });
      localStorage.setItem('chat_history', JSON.stringify(items));
    }

    function loadHistory() {
      try {
        const stored = JSON.parse(localStorage.getItem('chat_history') || '[]');
        stored.forEach(m => addMessage(m.role === 'user' ? 'user' : 'assistant', m.content));
      } catch(_){}
    }

    function clearComposer() {
      inputEl.value = '';
      inputEl.style.height = 'auto';
    }

    // Auto-grow textarea
    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + 'px';
      sendBtn.disabled = !inputEl.value.trim();
    });

    // Keyboard shortcuts
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // Click send
    sendBtn.addEventListener('click', async () => {
      const query = inputEl.value.trim();
      if (!query) return;
      if (!API_URL) {
        alert('Please set API_URL in the source (or via localStorage). Open DevTools and run localStorage.setItem("API_URL", "https://your-api.execute-api.region.amazonaws.com/prod") then refresh.');
        return;
      }

      addMessage('user', query);
      clearComposer();

      setStatus('Thinking…');
      sendBtn.disabled = true;
      inputEl.disabled = true;

      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 60000);

        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...EXTRA_HEADERS,
          },
          body: JSON.stringify({ query }),
          signal: controller.signal,
        });
        clearTimeout(timeout);

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text || res.statusText}`);
        }

        // Expecting JSON like { answer: string } OR generic JSON -> pretty print
        const data = await res.json().catch(() => null);

        let content = '';
        if (data && typeof data === 'object') {
          // common shapes: {answer}, {message}, {output}, or full object
          content = data.answer || data.message || data.output || JSON.stringify(data, null, 2);
        } else {
          content = await res.text();
        }

        addMessage('assistant', content);
        setStatus('');
      } catch (err) {
        console.error(err);
        addMessage('assistant', `⚠️ Error: ${err.message || err}`);
        setStatus('Request failed', true);
      } finally {
        sendBtn.disabled = false;
        inputEl.disabled = false;
        inputEl.focus();
      }
    });

    // Persistence toggle
    persistEl.checked = localStorage.getItem('chat_history') ? true : false;
    if (persistEl.checked) loadHistory();

    persistEl.addEventListener('change', () => {
      if (!persistEl.checked) {
        localStorage.removeItem('chat_history');
      } else {
        saveHistory();
      }
    });

    // Optional: greet
    if (!localStorage.getItem('greeted')) {
      addMessage('assistant', 'Hi! Ask me about your AWS costs (e.g., “What are my AWS costs today?”)');
      localStorage.setItem('greeted', '1');
    }
  </script>
</body>
</html>
